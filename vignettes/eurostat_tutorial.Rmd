<!--
%\VignetteEngine{knitr}
%\VignetteIndexEntry{An R Markdown Vignette made with knitr}
-->

Eurostat R tools
===========

This R package provides tools to access [Eurostat open
data](http://epp.eurostat.ec.europa.eu/portal/page/portal/statistics/themes)
as part of the [rOpenGov](http://ropengov.github.io) project.

For contact information and source code, see the [github page](https://github.com/rOpenGov/eurostat)

## Installation

Release version for general use:

```{r install, eval=FALSE}
install.packages("eurostat")
library(eurostat)
```

Development version (potentially unstable):

```{r install2, eval=FALSE}
install.packages("devtools")
library(devtools)
install_github("eurostat", "ropengov")
library(eurostat)
```


## Accessing Eurostat data 

```{r eurostat, warning=FALSE, message=FALSE}
library(eurostat)

# Get Eurostat data listing
toc <- getEurostatTOC(); 
head(toc)

# info about passagers
grepEurostatTOC("split of passenger transport", type = "dataset")
grepEurostatTOC("split of passenger transport", type = "table")

# Pick ID for the table
id <- unique(grepEurostatTOC("split of passenger transport", 
      		             type = "table")$code)
id

# Get table with the given ID
tmp <- eurostat(id)
summary(tmp)
```


## Triangle plot for split of passenger transport

```{r plotGallery, warning=FALSE, message=FALSE}
library(reshape)
tmp <- eurostat("tsdtr210")
bus  <- cast(tmp, geo ~ time , mean, subset= vehicle=="BUS_TOT")
car <- cast(tmp, geo ~ time , mean, subset= vehicle=="CAR")
train   <- cast(tmp, geo ~ time , mean, subset= vehicle=="TRN")

# select 2010 data
allTransports <- data.frame(bus = bus[,"2010 "], 
                            car = car[,"2010 "],
                            train = train[,"2010 "])
# add countrynames
rownames(allTransports) <- levels(bus[,1])
allTransports <- na.omit(allTransports)

# triangle plot
library("plotrix")
triax.plot(allTransports, show.grid=TRUE, 
           label.points=TRUE, point.labels=rownames(allTransports), 
           pch=19)
```


## Working with country codes

Eurostat is using ISO2 format for country names, OECD is using ISO3 for their studies, and Statistics Finland uses full country names. The [countrycode](http://cran.r-project.org/web/packages/countrycode/index.html) package can be used to convert between these formats.

```{r countrycodes, warning=FALSE, message=FALSE}
library("countrycode")

# Use the country codes from previous examples
countries <- rownames(allTransports)
head(countries)

# From ISO2 (used by Eurostat) into ISO3 (used by OECD)
head(countrycode(countries, "iso2c", "iso3c"))

# From ISO2 (used by Eurostat) into ISO (short country names)
head(countrycode(rownames(allTransports), "iso2c", "country.name"))

```


## Mapping the household incomes at NUTS2 level

In the following exercise we are plotting household income data from Eurostat on map from three different years. In addition to downloading and manipulating data from EUROSTAT, you will learn how to access and use spatial shapefiles of Europe published by EUROSTAT at [Administrative units / Statistical units](http://epp.eurostat.ec.europa.eu/portal/page/portal/gisco_Geographical_information_maps/popups/references/administrative_units_statistical_units_1). 

### Retrieving and manipulating the data tabular data from Eurostat

First, we shall retrieve the nuts2-level figures of variable `tgs00026` (Disposable income of private households by NUTS 2 regions) and manipulate the extract the information for creating `unit` and `geo` variables.


```{r eurostat_map0, warning=FALSE, message=FALSE}
library(eurostat)
df <- getEurostatRaw("tgs00026")
names(df) <- c("xx", 2011:2000)
df$unit <- lapply(strsplit(as.character(df$xx), ","), "[", 2)
df$geo <- lapply(strsplit(as.character(df$xx), ","), "[", 3)
```

### Retrieving and manipulating the spatial data from GISCO

Second, we will download the zipped shapefile in 1:60 million scale from year 2010 and subset it at the level of NUTS2.


```{r eurostat_map1, warning=FALSE, message=FALSE}
# Load the GISCO shapefile
download.file("http://epp.eurostat.ec.europa.eu/cache/GISCO/geodatafiles/NUTS_2010_60M_SH.zip", 
    destfile="NUTS_2010_60M_SH.zip")
# unzip
unzip("NUTS_2010_60M_SH.zip")
library(rgdal)
# read into SpatialPolygonsDataFrame
map <- readOGR(dsn = "./NUTS_2010_60M_SH/data", layer = "NUTS_RG_60M_2010")
# subset the spatialpolygondataframe at NUTS2-level
map_nuts2 <- subset(map, STAT_LEVL_ == 2)
```

### Merge the tabular data with spatial data into single SpatialPolygonDataFrame

Third, we will make the both datas of same lenght, give then identical rownames and then merge the tabular data with the spatial data.


```{r eurostat_map2, warning=FALSE, message=FALSE}
# dim show how many regions are in the spatialpolygondataframe
dim(map_nuts2)
# dim show how many regions are in the data.frame
dim(df)
# Spatial dataframe has 467 rows and attribute data 275. 
# We need to make attribute data to have similar number of rows
NUTS_ID <- as.character(map_nuts2$NUTS_ID)
VarX <- rep(NA, 316)
dat <- data.frame(NUTS_ID,VarX)
# then we shall merge this with Eurostat data.frame
dat2 <- merge(dat,df,by.x="NUTS_ID",by.y="geo", all.x=TRUE)
## merge this manipulated attribute data with the spatialpolygondataframe
## rownames
row.names(dat2) <- dat2$NUTS_ID
row.names(map_nuts2) <- as.character(map_nuts2$NUTS_ID)
## order data
dat2 <- dat2[order(row.names(dat2)), ]
map_nuts2 <- map_nuts2[order(row.names(map_nuts2)), ]
## join
library(maptools)
dat2$NUTS_ID <- NULL
shape <- spCbind(map_nuts2, dat2)
```


### Fortify the shapefile into data.frame and ready for ggplot-plotting

As we are using ggplot2-package for plotting, we have to fortify the `SpatialPolygonDataFrame` into regular `data.frame`-class. As we have income data from several years, we have to also melt the data into long format for plotting.


```{r eurostat_map3, warning=FALSE, message=FALSE}
## fortify spatialpolygondataframe into data.frame
library(ggplot2)
library(rgeos)
shape$id <- rownames(shape@data)
map.points <- fortify(shape, region = "id")
map.df <- merge(map.points, shape, by = "id")
# As we want to plot map faceted by years from 2003 to 2011
# we have to melt it into long format 
#
# (variable with numerical names got X-prefix during the spCbind-merge, 
# therefore the X-prefix in variable names)

library(reshape2)
map.df.l <- melt(data = map.df, 
                 id.vars = c("id","long","lat","group","NUTS_ID"), 
                 measure.vars = c("X2000","X2001","X2002",
                                  "X2003","X2004","X2005",
                                  "X2006","X2007","X2008",
                                  "X2009","X2010","X2011"))
# year variable (variable) is class string and type X20xx. 
# Lets remove the X and convert it to numerical
library(stringr)
map.df.l$variable <- str_replace_all(map.df.l$variable, "X","")
map.df.l$variable <- factor(map.df.l$variable)
map.df.l$variable <- as.numeric(levels(map.df.l$variable))[map.df.l$variable]
```

### And finally the plot using ggplot2

Map shows the distribution of *disposable income of private households* at NUTS2 level and the color coding is done so that middle of the scale (white color) is the median count from that particular year. **It is important to note that it is not the median income of European households, but the median of the NUTS2-level aggregates**

```{r eurostat_map4, warning=FALSE, message=FALSE}
library(ggplot2)
library(scales)
# lets choose only three years
map.df.l <- map.df.l[map.df.l$variable == c(2000,2005,2011), ]
# years for for loop
years <- unique(map.df.l$variable)
for (year in years) {
  median_in_data <- median(map.df.l[map.df.l$variable == year,]$value, na.rm = TRUE)
  print(ggplot(data=map.df.l[map.df.l$variable == year,], 
         aes(long,lat,group=group)) +
  geom_polygon(aes(fill = value), 
               colour="white", 
               size=.2) +
  geom_polygon(data = map.df.l, aes(long,lat), 
               fill=NA,
               colour="white", 
               size = 0.1) + 
  scale_fill_gradient2(low="#d8b365", 
                       high="#5ab4ac", 
                       midpoint=median_in_data) +
  coord_map(project="orthographic", xlim=c(-22,34),
            ylim=c(35,70)) + 
  labs(title = paste0("Year ",
                      year,
                      ". Median of \n regional incomes (tgs00026)  is ",
                      median_in_data))
       )
  }

```



### Citing the package

This R package is based on earlier CRAN packages [statfi](http://cran.r-project.org/web/packages/statfi/index.html) and [smarterpoland](http://cran.r-project.org/web/packages/SmarterPoland/index.html). The [datamart](http://cran.r-project.org/web/packages/datamart/index.html) package contains related tools for Eurostat but at the time of writing this tutorial this package seems to be in an experimental stage.

**Citing the Data** Kindly cite [Eurostat](http://epp.eurostat.ec.europa.eu/portal/page/portal/statistics/search_database). 


**Citing the R tools** This work can be freely used, modified and
distributed under the [BSD-2-clause (modified FreeBSD)
license]. Kindly cite the R package as 'Leo Lahti, Przemyslaw Biecek
and Markus Kainu (C) 2014. eurostat R package. URL:
http://ropengov.github.io/eurostat'.


### Session info

This tutorial was created with

```{r sessioninfo, message=FALSE, warning=FALSE}
sessionInfo()
```
