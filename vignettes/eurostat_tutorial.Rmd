<!--
%\VignetteEngine{knitr}
%\VignetteIndexEntry{An R Markdown Vignette made with knitr}
-->


Eurostat R tools
===========

This R package provides tools to access [Eurostat open
data](http://epp.eurostat.ec.europa.eu/portal/page/portal/statistics/themes)
as part of the [rOpenGov](http://ropengov.github.io) project.

For contact information and source code, see the [github page](https://github.com/rOpenGov/eurostat)

## Installation

Release version for general use:

```{r install, eval=FALSE}
install.packages("eurostat")
library(eurostat)
```

Development version (potentially unstable):

```{r install2, eval=FALSE}
install.packages("devtools")
library(devtools)
install_github("eurostat", "ropengov")
library(eurostat)
```


## Finding the data


Function `getEurostatTOC` downloads a table of contents of eurostat datasets. Note that the values in column 'code' should be used to download a selected dataset.

```{r getEurostatTOC, warning=FALSE, message=FALSE}
library(eurostat)

# Get Eurostat data listing
toc <- getEurostatTOC()
toc[200:210,]
```

With `grepEurostatTOC` you can search through the table of content for particular patterns, e.g. all datasets related to income.

```{r grepEurostatTOC, warning=FALSE, message=FALSE}
# info about passengers
head(grepEurostatTOC("income", type = "dataset"))
grepEurostatTOC("Disposable income", type = "table")
```


## Downloading the data 

Package has two functions for downloading the data. When using `get_eurostat_raw` the data is transformed into the tabular format, whereas `get_eurostat` returns dataset transformed into the molten / row-column-value format (RCV). Let's focus on indicator ([Disposable income of private households by NUTS 2 regions](http://epp.eurostat.ec.europa.eu/portal/page/portal/product_details/dataset?p_product_code=TGS00026)) in this chapter. See the examples below.


```{r get_eurostat_raw, warning=FALSE, message=FALSE, results='asis'}
# Pick ID for the table
id <- unique(grepEurostatTOC("Disposable income", 
        	             type = "table")$code)
# Get table with the given ID
dat_raw <- get_eurostat_raw(id)
# lets use kable function from knitr for nicer table outputs
library(knitr)
kable(head(dat_raw))
```


```{r get_eurostat, warning=FALSE, message=FALSE, results='asis'}
dat <- get_eurostat(id)
kable(head(dat))
```


### Labelling the data

Function `label_eurostat`  replaces the eurostat codes with definitions from Eurostat dictionaries for data frames created using `get_eurostat`-function.

```{r label_eurostat, warning=FALSE, message=FALSE, results='asis'}
datl <- label_eurostat(dat)

kable(head(datl))
```


## Some plotting examples and working with country/region names

### Triangle plot for split of passenger transport

```{r plotGallery, warning=FALSE, message=FALSE}
library(reshape)
tmp <- get_eurostat("tsdtr210")
bus  <- cast(tmp, geo ~ time , mean, subset= vehicle=="BUS_TOT")
car <- cast(tmp, geo ~ time , mean, subset= vehicle=="CAR")
train   <- cast(tmp, geo ~ time , mean, subset= vehicle=="TRN")

# select 2010 data
allTransports <- data.frame(bus = bus[,"2010"], 
                            car = car[,"2010"],
                            train = train[,"2010"])
# add countrynames
rownames(allTransports) <- levels(bus[,1])
allTransports <- na.omit(allTransports)

# triangle plot
library("plotrix")
triax.plot(allTransports, show.grid=TRUE, 
           label.points=TRUE, point.labels=rownames(allTransports), 
           pch=19)
```


### Working with country codes

Eurostat is using ISO2 format for country names, OECD is using ISO3 for their studies, and Statistics Finland uses full country names. There are (at least) two ways to solve the issue. First one is to apply `label_eurostat`-function to your dataset.

```{r countrycodes1, warning=FALSE, message=FALSE}
tmp <- get_eurostat("tsdtr210")
tmpl <- label_eurostat(tmp)

head(tmpl)
```

A second option is to use [countrycode](http://cran.r-project.org/web/packages/countrycode/index.html) package can be used to convert between these formats.

```{r countrycodes, warning=FALSE, message=FALSE}
library("countrycode")

# Use the country codes from previous examples
countries <- rownames(allTransports)
head(countries)

# From ISO2 (used by Eurostat) into ISO3 (used by OECD)
head(countrycode(countries, "iso2c", "iso3c"))

# From ISO2 (used by Eurostat) into ISO (short country names)
head(countrycode(rownames(allTransports), "iso2c", "country.name"))
```


### Working with regional level data from Eurostat

For most part the Eurostat datasets are of country-year -type. However, many indicators have are also provided at lower level of regional breakdown following the [NUTS-scheme](http://en.wikipedia.org/wiki/Nomenclature_of_Territorial_Units_for_Statistics). (Look [this document](http://ec.europa.eu/eurostat/ramon/nomenclatures/index.cfm?TargetUrl=DSP_GEN_DESC_VIEW_NOHDR&StrNom=NUTS_33&StrLanguageCode=EN) for more details by Eurostat).

In this exercise we plot nuts2-level figures of variable `tgs00026`.

First, we shall retrieve the data and munge the raw data to extract the information for creating id-variables `unit`, `region`, `cntry` and `countryname`.

```{r eurostat_region_data, warning=FALSE, message=FALSE}
library(eurostat)
dat <- get_eurostat("tgs00026")
# Extract the information on country in question. (First two character in region string mark the country)
dat$cntry <- substr(dat$geo, 1,2)
# Create the variable for proper countrynames using countryname-package
library(countrycode)
dat$countryname <- countrycode(dat$cntry, "iso2c", "country.name")

library(ggplot2)
# convert time column from factor to numeric
dat$time <- as.numeric(levels(dat$time))[dat$time]

ggplot(dat, aes(x=time,y=value,
                  group=geo,
                  color=cntry)) +
  geom_point() + geom_line() + 
  geom_text(data=merge(dat, 
                         aggregate(time ~ geo, dat, max),
                         by=c("time","geo")),
              aes(x=time, y = value, label=geo),
              hjust=-0.5,vjust=-1,size=3) +
  coord_cartesian(xlim=c(2000:2014)) +
  labs(x="Year",
       y="Disposable income of private households (€ per year)")
```


#### Adding region names

Again, there are two options for adding the region names. Eurostat's [Ramon metadata server](http://ec.europa.eu/eurostat/ramon/index.cfm?TargetUrl=DSP_PUB_WELC) provides keys for linking the the NUTS codes with original names of the regions in native languages. This [zipfile](http://ec.europa.eu/eurostat/ramon/documents/nuts/NUTS_2010.zip) contains the NUTS codes with region names and hierarchy levels from 2010.

However, using `label_eurostat` is more straightforward. For clarity, we shall subset first four countries from the data in alphabetical order and plot the same indicator as above from those countries including the region names.

```{r eurostat_region_names, warning=FALSE, message=FALSE, fig.height=12}
dat <- get_eurostat("tgs00026")

# Extract the information on country in question. (First two character in region string mark the country)
cntry <- substr(dat$geo, 1,2)
# apply the definitions from dictionary
datl <- label_eurostat(dat)
# add the countrycodes as a new column
datl$cntry <- cntry
# use countrycode-package to convert them to country names
library(countrycode)
datl$cntry <- countrycode(datl$cntry, "iso2c", "country.name")

# plot the data using country facets
library(ggplot2)
# convert time column from factor to numeric
datl$time <- as.numeric(levels(datl$time))[datl$time]
# subset the countries
datl2 <- datl[datl$cntry %in% c("Austria","Belgium","Bulgaria","Czech Republic"),]

ggplot(datl2, 
       aes(x=time,y=value,
                  group=geo)) +
  geom_point(color="grey") + geom_line(color="grey") + 
  geom_text(data=merge(datl2, 
                         aggregate(time ~ geo, datl2, max),
                         by=c("time","geo")),
              aes(x=time, y = value, label=geo),
            vjust=1,size=3) +
  coord_cartesian(xlim=c(2000:2014)) +
  facet_wrap(~cntry, scales = "free", ncol = 1) +
  labs(x="Year",
       y="Disposable income of private households (€ per year)")
```

For spatial illustrations of regional data, see this post: [rOpenGov.github.io](http://ropengov.github.io/) at rOpenGov blog.

## Citing the package

This R package is based on earlier CRAN packages [statfi](http://cran.r-project.org/web/packages/statfi/index.html) and [smarterpoland](http://cran.r-project.org/web/packages/SmarterPoland/index.html). The [datamart](http://cran.r-project.org/web/packages/datamart/index.html) package contains related tools for Eurostat but at the time of writing this tutorial this package seems to be in an experimental stage.

**Citing the Data** Kindly cite [Eurostat](http://epp.eurostat.ec.europa.eu/portal/page/portal/statistics/search_database). 


**Citing the R tools** This work can be freely used, modified and
distributed under the [BSD-2-clause (modified FreeBSD)
license]. Kindly cite the R package as 'Leo Lahti, Przemyslaw Biecek, Janne Huovari and Markus Kainu (C) 2014. eurostat R package. URL: http://ropengov.github.io/eurostat'.


## Session info

This tutorial was created with

```{r sessioninfo, message=FALSE, warning=FALSE}
sessionInfo()
```
