<!--
%\VignetteEngine{knitr}
%\VignetteIndexEntry{An R Markdown Vignette made with knitr}
-->


Eurostat R tools
===========

This R package provides tools to access [Eurostat open
data](http://epp.eurostat.ec.europa.eu/portal/page/portal/statistics/themes)
as part of the [rOpenGov](http://ropengov.github.io) project.

For contact information and source code, see the [github page](https://github.com/rOpenGov/eurostat)

## Installation

Release version for general use:

```{r install, eval=FALSE}
install.packages("eurostat")
library(eurostat)
```

Development version (potentially unstable):

```{r install2, eval=FALSE}
install.packages("devtools")
library(devtools)
install_github("eurostat", "ropengov")
library(eurostat)
```


## Accessing Eurostat data 

```{r eurostat, warning=FALSE, message=FALSE}
library(eurostat)

# Get Eurostat data listing
toc <- getEurostatTOC(); 
head(toc)

# info about passagers
grepEurostatTOC("split of passenger transport", type = "dataset")
grepEurostatTOC("split of passenger transport", type = "table")

# Pick ID for the table
id <- unique(grepEurostatTOC("split of passenger transport", 
      		             type = "table")$code)
id

# Get table with the given ID
tmp <- get_eurostat(id)
summary(tmp)
```


## Triangle plot for split of passenger transport

```{r plotGallery, warning=FALSE, message=FALSE}
library(reshape)
tmp <- get_eurostat("tsdtr210")
bus  <- cast(tmp, geo ~ variable , mean, subset= vehicle=="BUS_TOT")
car <- cast(tmp, geo ~ variable , mean, subset= vehicle=="CAR")
train   <- cast(tmp, geo ~ variable , mean, subset= vehicle=="TRN")

# select 2010 data
allTransports <- data.frame(bus = bus[,"2010 "], 
                            car = car[,"2010 "],
                            train = train[,"2010 "])
# add countrynames
rownames(allTransports) <- levels(bus[,1])
allTransports <- na.omit(allTransports)

# triangle plot
library("plotrix")
triax.plot(allTransports, show.grid=TRUE, 
           label.points=TRUE, point.labels=rownames(allTransports), 
           pch=19)
```


## Working with country codes

Eurostat is using ISO2 format for country names, OECD is using ISO3 for their studies, and Statistics Finland uses full country names. The [countrycode](http://cran.r-project.org/web/packages/countrycode/index.html) package can be used to convert between these formats.

```{r countrycodes, warning=FALSE, message=FALSE, eval=FALSE}
library("countrycode")

# Use the country codes from previous examples
countries <- rownames(allTransports)
head(countries)

# From ISO2 (used by Eurostat) into ISO3 (used by OECD)
head(countrycode(countries, "iso2c", "iso3c"))

# From ISO2 (used by Eurostat) into ISO (short country names)
head(countrycode(rownames(allTransports), "iso2c", "country.name"))

```


## Working with Regional level data from Eurostat

For most part the Eurostat datasets are of country-year -type. However, many indicators have are also provided at lower level of regional breakdown following the [NUTS-scheme](http://en.wikipedia.org/wiki/Nomenclature_of_Territorial_Units_for_Statistics). (Look [this document](http://ec.europa.eu/eurostat/ramon/nomenclatures/index.cfm?TargetUrl=DSP_GEN_DESC_VIEW_NOHDR&StrNom=NUTS_33&StrLanguageCode=EN) for more details by Eurostat).

In this exercise we plot nuts2-level figures of variable `tgs00026` ([Disposable income of private households by NUTS 2 regions](http://epp.eurostat.ec.europa.eu/portal/page/portal/product_details/dataset?p_product_code=TGS00026)).

First, we shall retrieve the data and munge the raw data to extract the information for creating id-variables `unit`, `region`, `cntry` and `countryname`.

```{r eurostat_region_data, warning=FALSE, message=FALSE}
library(eurostat)
dat <- getEurostatRaw("tgs00026")
# Replace the varnames
names(dat) <- c("xx", 2011:2000)
# Extract the information on unit of measurement
dat$unit <- as.character(lapply(strsplit(as.character(dat$xx), ","), "[", 2))
# Extract the information on region in question
dat$region <- as.character(lapply(strsplit(as.character(dat$xx), ","), "[", 3))
# Extract the information on country in question. (First two character in region string mark the country)
dat$cntry <- substr(dat$region, 1,2)
# Create the variable for proper countrynames using countryname-package
library(countrycode)
dat$countryname <- countrycode(dat$cntry, "iso2c", "country.name")

# drop out the xx var as no longer needed
dat <- dat[,-1]
# convert data into long format for plotting
library(reshape2)
dat.l <- melt(data = dat, 
                 id.vars = c("unit","region","cntry","countryname"), 
                 measure.vars = 1:12)
dat.l$variable <- as.numeric(levels(dat.l$variable))[dat.l$variable]
# remove all the rows that have NA in value
dat.l <- dat.l[!is.na(dat.l$value), ]
# print the first six rows
head(dat.l)
```

After the data is in long format it is a straightforward task to plot is using ggplot2-package.

```{r eurostat_plot1, warning=FALSE, message=FALSE}
library(ggplot2)
ggplot(dat.l, aes(x=variable,y=value,
                  group=region,
                  color=cntry)) +
  geom_point() + geom_line() + 
  geom_text(data=merge(dat.l, 
                         aggregate(variable ~ region, dat.l, max),
                         by=c("variable","region")),
              aes(x=variable, y = value, label=region),
              hjust=-0.5,vjust=-1,size=3) +
  coord_cartesian(xlim=c(2000:2014)) +
  labs(x="Year",
       y="Disposable income of private households (€ per year)")
```


### Adding region names

As the NUTS codes are not informative *per se*, Eurostat's [Ramon metadata server](http://ec.europa.eu/eurostat/ramon/index.cfm?TargetUrl=DSP_PUB_WELC) provides keys for linking the the NUTS codes with original names of the regions in native languages. 

The following code downloads the zipfile, unzips it and reads the key data into R. (There are some issues with character encodings when reading the .xls-file). For clarity, we shall subset first four countries from the data in alphabetical order and plot the same indicator as above from those countries includin the native region names.

```{r eurostat_region_names, warning=FALSE, message=FALSE, fig.height=12}
# download, unzip and read the key table forregion names
download.file("http://ec.europa.eu/eurostat/ramon/documents/nuts/NUTS_2010.zip", 
              destfile = "zipfile")
unzip("zipfile")
library(gdata)
region_map <- read.xls("NUTS_2010.xls", sheet=1)
# merge the region key with the income data data (subset the four countries at the same time)
dat.l2 <- merge(dat.l[dat.l$cntry %in% c("AT","BE","BG","CZ"),],
                region_map,
                by.x="region",
                by.y="NUTS.CODE")
# plot the data using country facets
library(ggplot2)
ggplot(dat.l2, aes(x=variable,y=value,
                  group=region)) +
  geom_point() + geom_line() + 
  geom_text(data=merge(dat.l2, 
                         aggregate(variable ~ NUTS.LABEL, dat.l2, max),
                         by=c("variable","NUTS.LABEL")),
              aes(x=variable, y = value, label=NUTS.LABEL),
            vjust=-1,size=3) +
  coord_cartesian(xlim=c(2000:2014)) +
  facet_wrap(~countryname, scales = "free", ncol = 1) +
  labs(x="Year",
       y="Disposable income of private households (€ per year)")
```

For spatial illustrations of regional data, see this post: [rOpenGov.github.io](http://ropengov.github.io/) at rOpenGov blog.

### Citing the package

This R package is based on earlier CRAN packages [statfi](http://cran.r-project.org/web/packages/statfi/index.html) and [smarterpoland](http://cran.r-project.org/web/packages/SmarterPoland/index.html). The [datamart](http://cran.r-project.org/web/packages/datamart/index.html) package contains related tools for Eurostat but at the time of writing this tutorial this package seems to be in an experimental stage.

**Citing the Data** Kindly cite [Eurostat](http://epp.eurostat.ec.europa.eu/portal/page/portal/statistics/search_database). 


**Citing the R tools** This work can be freely used, modified and
distributed under the [BSD-2-clause (modified FreeBSD)
license]. Kindly cite the R package as 'Leo Lahti, Przemyslaw Biecek, Janne Huovari and Markus Kainu (C) 2014. eurostat R package. URL: http://ropengov.github.io/eurostat'.


### Session info

This tutorial was created with

```{r sessioninfo, message=FALSE, warning=FALSE}
sessionInfo()
```
